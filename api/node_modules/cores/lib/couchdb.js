var Url = require('url');
var Q = require('kew');
var Request = require('request');


function checkError(err, req, res, body) {
  if (err) {
    return err;
  }
  if (res.statusCode < 400) {
    return null;
  }
  var payload = typeof body === 'string' ? JSON.parse(body) : body;
  var cErr = new Error(payload.reason || 'couch returned ' + res.statusCode);
  cErr.statusCode = res.statusCode,
  cErr.request = req;
  cErr.response = res;
  return cErr;
}


function stringifySearchParams(qs) {
  var s = {};
  Object.keys(qs).forEach(function(key) {
    if (typeof qs[key] !== 'string') {
      try {
        s[key] = JSON.stringify(qs[key]);
      }
      catch(e) {
      }
    }
<<<<<<< HEAD
=======
    else if ((key === 'key' || key === 'startkey' || key === 'endkey' || key === 'keys')
             && (qs[key].charAt(0) !== '\"' && qs[key].charAt(0) !== '[')) {
      s[key] = '\"' + qs[key] + '\"';
    }
>>>>>>> upstream/main
    else {
      s[key] = qs[key];
    }
  });
  return s;
}


<<<<<<< HEAD
module.exports = function(dbUrl) {

  return {

    load: function load(id, qs) {
      var defer = Q.defer();
      var req = Request.get(dbUrl + '/' + id, { qs: qs }, function(resErr, res, body) {
=======
module.exports = function(db) {

  // db can be an url or an object of type { url, [user, pass] }

  var dbUrl = typeof db === 'string' ? db : db.url;
  var auth = db.user && db.pass ? { user: db.user, pass: db.pass } : '';

  if (!dbUrl) {
    throw new Error('No couchdb url given');
  }

  return {
    //
    // load document by id
    //
    load: function load(id, qs) {
      var defer = Q.defer();
      var req = Request({
        method: 'GET',
        url: dbUrl + '/' + id,
        auth: auth,
        qs: qs
      }, function(resErr, res, body) {
>>>>>>> upstream/main
        var err = checkError(resErr, req, res, body);
        if (err) {
          return defer.reject(err);
        }
        defer.resolve(JSON.parse(body));
      });
      return defer.promise;
    },


    //
<<<<<<< HEAD
    // id is optional
    //
    save: function save(doc, qs) {
      var defer = Q.defer();
      var method = 'post';
=======
    // save document
    //
    save: function save(doc, qs) {
      var defer = Q.defer();
      var method = 'POST';
>>>>>>> upstream/main
      var url = dbUrl;
      qs = qs || {};

      function replacer(key, value) {
        if (typeof value === 'function') {
          return value.toString();
        }
        return value;
      }

      if (doc._id) {
        // create or update with id
<<<<<<< HEAD
        method = 'put';
=======
        method = 'PUT';
>>>>>>> upstream/main
        url += '/' + doc._id;
        if (doc._rev) {
          // update with rev
          qs.rev = doc._rev;
        }
      }

      var req = Request({
<<<<<<< HEAD
        url: url,
        method: method,
=======
        method: method,
        url: url,
        auth: auth,
>>>>>>> upstream/main
        qs: qs,
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: typeof doc === 'string' ? doc : JSON.stringify(doc, replacer)

      }, function(resErr, res, body) {
        var err = checkError(resErr, req, res, body);
        if (err) {
          return defer.reject(err);
        }
        defer.resolve(JSON.parse(body));
      });
      return defer.promise;
    },


<<<<<<< HEAD
    bulkSave: function bulkSave(docs, qs) {
      var defer = Q.defer();
      var req = Request({
        url: dbUrl + '/_bulk_docs',
        method: 'post',
=======
    //
    // save array of documents
    //
    bulkSave: function bulkSave(docs, qs) {
      var defer = Q.defer();
      var req = Request({
        method: 'POST',
        url: dbUrl + '/_bulk_docs',
        auth: auth,
>>>>>>> upstream/main
        qs: qs,
        json: docs

      }, function(resErr, res, body) {
        var err = checkError(resErr, req, res, body);
        if (err) {
          return defer.reject(err);
        }
        defer.resolve(body);
      });
      return defer.promise;
    },


<<<<<<< HEAD
    bulkLoad: function bulkLoad(keys, qs) {
      var defer = Q.defer();
      var req = Request({
        url: dbUrl + '/_all_docs',
        method: 'post',
        qs: qs,
        json: { keys: keys || [] }

=======
    //
    // load documents by ids
    //
    bulkLoad: function bulkLoad(keys, qs) {
      var defer = Q.defer();
      var req = Request({
        method: 'POST',
        url: dbUrl + '/_all_docs',
        auth: auth,
        qs: qs,
        json: { keys: keys || [] }
>>>>>>> upstream/main
      }, function(resErr, res, body) {
        var err = checkError(resErr, req, res, body);
        if (err) {
          return defer.reject(err);
        }
        defer.resolve(body);
      });
      return defer.promise;
    },


<<<<<<< HEAD
=======
    //
    // delete document
    //
>>>>>>> upstream/main
    destroy: function destroy(id, rev) {
      var defer = Q.defer();
      var qs = { rev: rev };

      var req = Request({
<<<<<<< HEAD
        method: 'delete',
        url: dbUrl + '/' + id,
        qs: qs

=======
        method: 'DELETE',
        url: dbUrl + '/' + id,
        auth: auth,
        qs: qs
>>>>>>> upstream/main
      }, function(resErr, res, body) {
        var err = checkError(resErr, req, res, body);
        if (err) {
          return defer.reject(err);
        }
        defer.resolve(JSON.parse(body));
      }
                       );
      return defer.promise;
    },


<<<<<<< HEAD
    view: function view(designName, viewName, qs) {
      var defer = Q.defer();

      var req = Request.get(
        dbUrl + '/_design/' + designName + '/_view/' + viewName,
        { qs: stringifySearchParams(qs) },

        function(resErr, res, body) {
=======
    //
    // call design view
    //
    view: function view(designName, viewName, qs) {
      var defer = Q.defer();
      var req = Request({
        method: 'GET',
        url: dbUrl + '/_design/' + designName + '/_view/' + viewName,
        auth: auth,
        qs: stringifySearchParams(qs)
      }, function(resErr, res, body) {
>>>>>>> upstream/main
          var err = checkError(resErr, req, res, body);
          if (err) {
            return defer.reject(err);
          }
          defer.resolve(JSON.parse(body));
        }
      );
      return defer.promise;
    },


<<<<<<< HEAD
=======
    //
    // call search index
    //
    search: function(designName, indexName, qs) {
      var defer = Q.defer();
      var req = Request({
        method: 'GET',
        url: dbUrl + '/_design/' + designName + '/_search/' + indexName,
        auth: auth,
        qs: stringifySearchParams(qs)
      }, function(resErr, res, body) {
          var err = checkError(resErr, req, res, body);
          if (err) {
            return defer.reject(err);
          }
          defer.resolve(JSON.parse(body));
        }
      );
      return defer.promise;
    },


    //
    // get a bunch of fresh uuids
    //
>>>>>>> upstream/main
    uuids: function uuids(count) {
      count = count || 1;
      var defer = Q.defer();
      var parts = Url.parse(dbUrl);
<<<<<<< HEAD

      var req = Request.get(
        parts.protocol + '//' + parts.host + '/_uuids',
        { qs: { count: count }},

        function(resErr, res, body) {
=======
      var req = Request({
        method: 'GET',
        url: parts.protocol + '//' + parts.host + '/_uuids',
        auth: auth,
        qs: { count: count }
      }, function(resErr, res, body) {
>>>>>>> upstream/main
          var err = checkError(resErr, req, res, body);
          if (err) {
            return defer.reject(err);
          }
          defer.resolve(JSON.parse(body));
        }
      );
      return defer.promise;
    },


<<<<<<< HEAD
    info: function info() {
      var defer = Q.defer();
      var req = Request.get(
        dbUrl,
        {},
        function(resErr, res, body) {
=======
    //
    // database info
    //
    info: function info() {
      var defer = Q.defer();
      var req = Request({
        method: 'GET',
        url: dbUrl,
        auth: auth
      }, function(resErr, res, body) {
>>>>>>> upstream/main
          var err = checkError(resErr, req, res, body);
          if (err) {
            return defer.reject(err);
          }
          defer.resolve(JSON.parse(body));
        }
      );
      return defer.promise;
    },


<<<<<<< HEAD
    createDB: function createDB(name) {
      var defer = Q.defer();
      var req = Request({
        url: dbUrl,
        method: 'put'

=======
    //
    // create a database
    //
    createDB: function createDB(name) {
      var defer = Q.defer();
      var req = Request({
        method: 'PUT',
        url: dbUrl,
        auth: auth
>>>>>>> upstream/main
      }, function(resErr, res, body) {
          var err = checkError(resErr, req, res, body);
          if (err) {
            return defer.reject(err);
          }
          defer.resolve(JSON.parse(body));
      });
      return defer.promise;
    },


<<<<<<< HEAD
    destroyDB: function destroyDB(name) {
      var defer = Q.defer();
      var req = Request({
        url: dbUrl,
        method: 'delete'

=======
    //
    // destroy a database
    //
    destroyDB: function destroyDB(name) {
      var defer = Q.defer();
      var req = Request({
        method: 'DELETE',
        url: dbUrl,
        auth: auth
>>>>>>> upstream/main
      }, function(resErr, res, body) {
          var err = checkError(resErr, req, res, body);
          if (err) {
            return defer.reject(err);
          }
          defer.resolve(JSON.parse(body));
      });
      return defer.promise;
    }
  };
};